<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Audio Visualization</title>
    <style>
        canvas {
            width: 100%;
            height: 200px;
            background-color: black;
        }
    </style>
</head>
<body>
<canvas id="visualizer"></canvas>
<br>
<button id="playBtn" onclick="togglePlayback()">Play/Pause</button>
<button id="changeBtn" onclick="changeAudio()">Change Audio</button>

<script>
  let audioContext, analyser, bufferLength, dataArray, audioElement
  setTimeout(() => {
    console.log('开始')
    // 创建 AudioContext
    audioContext = new window.AudioContext();

    // 创建 AnalyserNode
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);

    // 创建音频标签元素
    // audioElement = new Audio();
    audioElement = document.createElement('audio');
    audioElement.src = '../Audio/assets/music/ADVENTURE_PARTY.mp3';

    // 连接音频元素到 AnalyserNode
    const source = audioContext.createMediaElementSource(audioElement);
    source.connect(analyser);
    source.connect(audioContext.destination);

    // 获取画布和上下文
    const canvas = document.getElementById('visualizer');
    const canvasCtx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;

    // 绘制频谱图
    function draw() {
      requestAnimationFrame(draw);

      analyser.getByteFrequencyData(dataArray);

      canvasCtx.fillStyle = 'rgb(0, 0, 0)';
      canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

      const barWidth = (WIDTH / bufferLength) * 2.5;
      let x = 0;

      for (let i = 0; i < bufferLength; i++) {
        const barHeight = (dataArray[i] / 255) * HEIGHT;

        canvasCtx.fillStyle = 'rgb(' + (barHeight + 100) + ',50,50)';
        canvasCtx.fillRect(x, HEIGHT - barHeight / 2, barWidth, barHeight / 2);

        x += barWidth + 1;
      }
    }

    // 开始绘制频谱图
    draw();
  }, 2000)

  // 暂停/播放切换
  function togglePlayback() {
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    } else if (audioContext.state === 'running') {
      audioContext.suspend();
    }
    audioElement.play();
    window.audioElement = audioElement
  }

  // 切换音频
  function changeAudio() {
    audioElement.src = '../Audio/assets/music/不怕.mp3';
    audioElement.play();
  }
</script>
</body>
</html>
