import{ref as t,reactive as e,computed as i,toRef as n,readonly as o}from"@vue/reactivity";import{watch as a}from"@vue/runtime-core";let r=[];window.addEventListener("resize",(function(t){r.forEach((e=>e(t)))}));const s=Promise.resolve();function l(t){return s.then(t)}function c(t){return"string"==typeof t?document.querySelector(t):t}function m(t,e){if(!e)return{...t};const i={};for(const n in{...t,...e}){const o=e[n],a=t[n];h(o)?i[n]=a:i[n]=o,"object"!=typeof o||o instanceof HTMLElement||Array.isArray(o)||(i[n]=m(a,o))}return i}function h(t){return null==t}function u(t,e,i){return h(i)?t&&e:t?e:i}function d(t,e){if(t)throw Error(e)}function p(t,e){t&&console.warn(e)}const f=(t,e,i)=>{if("object"!=typeof e)t.style[e]=i;else{Object.keys(e).forEach((i=>{t.style[i]=e[i]}))}};function g(t,e,...i){e?e(t,...i):t()}function v(t,...e){t.append(...e)}function b(t,e){t.className.indexOf(` ${e} `)>-1||(t.className+=` ${e} `)}function P(t,e=new WeakMap){if("object"!=typeof t)return t;if(e.has(t))return e.get(t);const i={};for(const e in t)"object"!=typeof t||h(t[e])?Array.isArray(t[e])?i[e]=[...t[e]]:h(t[e])?i[e]=null:t[e]instanceof Date?i[e]=new Date(t[e]):t[e]instanceof RegExp?i[e]=new RegExp(t[e]):"symbol"==typeof t[e]?i[e]=Symbol(t[e].description):i[e]=t[e]:i[e]=P(t[e]);return e.set(t,i),i}function y(t){const e={};for(const i in t)e[i]=t[i]+"px";return e}const x="magic_drag";function w(t){return` ${x}-${t}`}const S={OutlinePoint:w("outline_point"),ContainerClassName:w("menu_container"),ItemClassName:w("menu_item"),LockItemClassName:w("menu_item-lock"),LockTargetClassName:w("target-lock")};var T;function C(t,e){return t-Number(e.dataset.index)}!function(t){t[t.Normal=55555]="Normal",t[t.Checked=77777]="Checked",t[t.Locked=44444]="Locked",t[t.Uppermost=66666]="Uppermost",t[t.Lowest=33333]="Lowest"}(T||(T={}));class E{constructor(){this.elementStates=[],this.selectedElement=null,this.selectedState=null,this.subscriptions={}}registerElementState(t,e,i=!0){this.elementStates.push({element:t,state:e}),i&&this.setCurrentElement(t)}getElementState(t){const e=this.elementStates.find((e=>e.element===t));if(!e)throw Error("元素未注册");return e?e.state:null}updateElementState(t,e){const i=this.elementStates.find((e=>e.element===t));i&&(i.state=e,this.notifySubscribers(t,e))}get targetState(){return this.currentState.targetState}get currentElement(){return this.selectedElement}get currentState(){return this.selectedState}get size(){return this.elementStates.length}get notLockState(){return this.elementStates.filter((t=>!t.state.globalDataParameter.initialTarget.isLock)).filter((t=>t.state.elementParameter.privateTarget!==this.currentElement)).map((t=>({target:t.element,zIndex:t.state.globalDataParameter.initialTarget.zIndex})))}setCurrentElement(t){this.selectedElement=t,this.selectedState=this.getElementState(t),this.updatePublicTargetState(),this.notifySubscribers(this.selectedElement,this.selectedState)}updatePublicTargetState(){E.COORDINATE_KEY.forEach((t=>{this.currentState.stateParameter.targetState[t]=this.currentState.globalDataParameter.initialTarget[t]}))}updatePublicPointState(){E.COORDINATE_KEY.forEach((t=>{}))}subscribe(t,e){this.subscriptions[t]||(this.subscriptions[t]=[]),this.subscriptions[t].push(e)}unsubscribe(t,e){this.subscriptions[t]&&(this.subscriptions[t]=this.subscriptions[t].filter((t=>t!==e)))}notifySubscribers(t,e){const i=this.subscriptions.selection;i&&i.forEach((i=>i(t,e)))}}E.COORDINATE_KEY=["left","top","width","height"];const k=new E;class L{constructor(){this._plugins=new Map}get plugins(){return new Map(this._plugins)}registerPlugin(t,e){this._plugins.set(t,e)}installPlugin(){this.plugins.forEach((t=>{t.init()}))}uninstallPlugin(t){this.plugins.forEach((t=>{t.unbind()}))}callExtensionPoint(t,...e){this.plugins.forEach((i=>{"function"==typeof i[t]&&i[t](...e)}))}}let D=null;class I{constructor(t={}){this.options=t,this.isHasAdsorbElementX=!1,this.isHasAdsorbElementY=!1,this.isCenterX=!1,this.isCenterY=!1,this.name="refLine",Object.assign({gap:3,adsorbAfterStopDiff:!1},this.options)}init(){this.lines=function(){if(!D){D={xt:null,xc:null,xb:null,yl:null,yc:null,yr:null};for(const t in D){let e=D[t]=document.createElement("div");e.classList.add("ref-line",t),e.style.cssText="display:none;opacity:0.7;position:absolute;background:#4DAEFF;z-index: 99999;"+("x"===t[0]?"width:100%;height:1px;left:0;":"width:1px;height:100%;top:0;"),e.show=function(){this.style.display="block"},e.hide=function(){this.style.display="none"},e.isShow=function(){return"none"!==this.style.display},document.body.appendChild(e)}}return D}()}unbind(){}drag({elementParameter:t,stateParameter:e,globalDataParameter:i,optionParameter:n},{movement:o,_updateContourPointPosition:a,_updateState:r}){this.checkAdsorb({elementParameter:t},"drag",(({top:t,left:e})=>{o.x-=e,o.y-=t,a(o),r(o)}))}resize({elementParameter:t},{movementX:e,movementY:i,_updateTargetStyle:n,_updatePointPosition:o}){this.checkAdsorb({elementParameter:t},"resize",(({top:t,left:a})=>{e.value-=a,i.value-=t,n({movementX:e,movementY:i}),o({movementX:e,movementY:i})}))}targetPressChange(t,e){t?this.checkAdsorb({elementParameter:e},"drag"):this.hideRefLine()}pointPressChange(t,e){t?this.checkAdsorb({elementParameter:e},"drag"):this.hideRefLine()}checkAdsorb({elementParameter:t},e,i){const{privateTarget:n,allTarget:o}=t,a=o.filter((t=>t!==n));let r=n.getBoundingClientRect();this.hideRefLine();let s=r.width/2,l=r.height/2;const{adsorbAfterStopDiff:c}=this.options;Array.from(a).forEach((t=>{if(this.isHasAdsorbElementX||this.isHasAdsorbElementY&&c)return;if(t.classList.remove("ref-line-active"),t===n)return;let{top:o,height:a,bottom:m,left:h,width:u,right:d}=t.getBoundingClientRect(),p=u/2,f=a/2,g={top:[{isNearly:this._isNearly(r.top,o),lineNode:this.lines.xt,lineValue:o,dragValue:o,distance:r.top-o,equality:a===r.height},{isNearly:this._isNearly(r.bottom,o),lineNode:this.lines.xt,lineValue:o,dragValue:o-r.height,distance:r.bottom-o,equality:a===r.height},{isNearly:this._isNearly(r.top+l,o+f),lineNode:this.lines.xc,lineValue:o+f,dragValue:o+f-l,distance:r.top+l-(o+f),equality:a===r.height,isCenter:!0},{isNearly:this._isNearly(r.bottom,m),lineNode:this.lines.xb,lineValue:m,dragValue:m-r.height,distance:r.bottom-m,equality:a===r.height},{isNearly:this._isNearly(r.top,m),lineNode:this.lines.xb,lineValue:m,dragValue:m,distance:r.top-m,equality:a===r.height}],left:[{isNearly:this._isNearly(r.left,h),lineNode:this.lines.yl,lineValue:h,dragValue:h,distance:r.left-h,equality:u===r.width},{isNearly:this._isNearly(r.right,h),lineNode:this.lines.yl,lineValue:h,dragValue:h-r.width,distance:r.right-h,equality:u===r.width},{isNearly:this._isNearly(r.left+s,h+p),lineNode:this.lines.yc,lineValue:h+p,dragValue:h+p-s,distance:r.left+s-(h+p),equality:u===r.width,isCenter:!0},{isNearly:this._isNearly(r.right,d),lineNode:this.lines.yr,lineValue:d,dragValue:d-r.width,distance:r.right-d,equality:u===r.width},{isNearly:this._isNearly(r.left,d),lineNode:this.lines.yr,lineValue:d,dragValue:d,distance:r.left-d,equality:u===r.width}]};for(let i in g)g[i].forEach((n=>{n.isNearly&&(t.classList.add("ref-line-active"),n.lineNode.style[i]=`${n.lineValue}px`,"drag"===e?(!this.isHasAdsorbElementX&&"left"===i||!this.isHasAdsorbElementY&&"top"===i||n.equality)&&n.lineNode.show():"resize"===e&&(!n.isCenter&&n.lineNode.show(),(n.isCenter&&"top"===i&&this._isNearly(a,r.height)||n.isCenter&&"left"===i&&this._isNearly(u,r.width))&&n.lineNode.show()),"top"===i?(this.isHasAdsorbElementY=!0,this.isCenterY=this.isCenterY||n.isCenter):(this.isHasAdsorbElementX=!0,this.isCenterX=this.isCenterX||n.isCenter))}));let v=g.top,b=g.left;"resize"===e&&(this.isHasAdsorbElementX&&this.isCenterX&&(b=b.filter((t=>!t.isCenter))),this.isHasAdsorbElementY&&this.isCenterY&&(v=v.filter((t=>!t.isCenter))));const P=v.map((t=>Math.abs(t.distance)<=this.options.gap?t.distance:0)).find((t=>Math.abs(t)>0)),y=b.map((t=>Math.abs(t.distance)<=this.options.gap?t.distance:0)).find((t=>Math.abs(t)>0));(this.isHasAdsorbElementX||this.isHasAdsorbElementY)&&i?.({top:P||0,left:y||0})}))}hideRefLine(){this.isHasAdsorbElementY=!1,this.isHasAdsorbElementX=!1,this.isCenterY=!1,this.isCenterX=!1,Object.values(this.lines).forEach((t=>t.hide())),Array.from(document.querySelectorAll(".ref-line-active")).forEach((t=>t.classList.remove("ref-line-active")))}_isNearly(t,e,i=!1){return i?t===e:Math.abs(t-e)<=this.options.gap}}const Y={"ctrl + a":t=>{t.preventDefault(),console.log("全选")},"ctrl + c":t=>{t.preventDefault(),console.log("复制")},"ctrl + v":t=>{t.preventDefault(),console.log("粘贴")},"ctrl + h":t=>{t.preventDefault(),console.log("帮助")},"ctrl + z":t=>{t.preventDefault(),console.log("撤销")},"ctrl + y":t=>{t.preventDefault(),console.log("重做")}};class X{constructor(){this.enableMap={},this.shortcuts={},this.name="keymap",this.bindTriggerShortcut=this.triggerShortcut.bind(this),this.configureShortcuts(Y)}init(){window.addEventListener("keydown",this.bindTriggerShortcut)}unbind(){window.removeEventListener("keydown",this.bindTriggerShortcut)}registerShortcut(t,e,i){t=t.replaceAll(" ","").toUpperCase(),t=this.functionOrder(t),console.log(t,"shortcut"),this.enableMap[t]=this.enableMap[t]??!0;const{priority:n=0}=i||{};this.shortcuts[t]||(this.shortcuts[t]=[]),this.shortcuts[t].push({action:e,priority:n}),this.shortcuts[t].sort(((t,e)=>e.priority-t.priority))}functionOrder(t){if(t.indexOf("++")>-1)throw Error("+ 不可以做为快捷键操作的key，如有必要请自行实现");const e=[];return t.indexOf(X.CTRL)>-1&&e.push(X.CTRL),(t=t.replace(X.CTRL,"")).indexOf(X.SHIFT)>-1&&e.push(X.SHIFT),(t=t.replace(X.SHIFT,"")).indexOf(X.ALT)>-1&&e.push(X.ALT),t=(t=t.replace(X.ALT,"")).replaceAll("+",""),e.push(t),e.join("+")}triggerShortcut(t){const e=this.getDescribeFromEvent(t);this.shortcuts[e]&&this.shortcuts[e].forEach((e=>e.action(t)))}getDescribeFromEvent(t){const e=[];return t.ctrlKey&&e.push(X.CTRL),t.shiftKey&&e.push(X.SHIFT),t.altKey&&e.push(X.ALT),e.push(t.key.toUpperCase()),e.join("+")}configureShortcuts(t){for(const e in t)this.registerShortcut(e,t[e])}enableShortcut(t){}disableShortcut(t){}}X.CTRL="CTRL",X.SHIFT="SHIFT",X.ALT="ALT";const z=new L;function N(a,r,s={}){const{limitDirection:m,throttleTime:h=10,offsetLeft:u=0,offsetTop:d=0}=s;let f;p(h>=100,"the throttleTime is greater than 100 and the visual effects may not be smooth"),l((function(){f=c(a),t=f,"absolute"===getComputedStyle(t).position||(t.style.position="absolute"),f.addEventListener("mousedown",C);var t}));const v=t(!1),b=e({x:0,y:0}),P=e({x:0,y:0}),y=e({x:0,y:0}),x=function(t,e,i={}){let{leading:n=!1}=i,o=!0;return(...i)=>{o&&(n&&(t(...i),n=!1),o=!1,setTimeout((()=>{t(...i),o=!0}),e))}}((function(t){if(!v.value)return;g((function(){t.preventDefault(),"X"!==m&&L({x:t.pageX-b.x}),"Y"!==m&&L({y:t.pageY-b.y}),P.x+y.x<u&&L({x:u-P.x}),P.y+y.y<d&&L({y:d-P.y}),E()}),r,w)}),10,{leading:!0}),w=(S=E,new Proxy(y,{get:(t,e,i)=>t[e],set:(t,e,i,n)=>(t[e]=i,S(),!0)}));var S;function T(){k(!1)}function C(t){t.preventDefault(),k(!0),L({x:0,y:0}),function({x:t,y:e}){P.x=t,P.y=e}({x:f.offsetLeft,y:f.offsetTop}),function({x:t,y:e}){b.x=t,b.y=e}({x:t.pageX,y:t.pageY}),window.addEventListener("mousemove",x),window.addEventListener("mouseup",T)}return{mouseX:i((()=>b.x-P.x)),mouseY:i((()=>b.y-P.y)),left:n(P,"x"),top:n(P,"y"),movementX:n(w,"x"),movementY:n(w,"y"),isPress:o(v),destroy:function(){f.removeEventListener("mousedown",C),window.removeEventListener("mousedown",x),window.removeEventListener("mouseup",T),f=null}};function E(){f.style.left=P.x+y.x+"px",f.style.top=P.y+y.y+"px"}function k(t){v.value=t}function L({x:t,y:e}){y.x=t??y.x,y.y=e??y.y}}const H={isInsertAction:!1,menuBox:null,actionElementList:[],isLock:!1,actions:null,currentTarget:null,classCopyPrefix:"box_copy_",copyIndex:0};function M(t,e){return{x:t.width*e,y:t.height*e}}const A={lock:{name:"lock",actionName:"锁定",actionDom:null,actionCallback(t){const{stateParameter:e,elementParameter:i,globalDataParameter:{initialTarget:n}}=t.currentState,{options:{lockTargetClassName:o}}=this.getMenuContextParameter();e.targetState.isLock=!n.isLock,n.isLock=!n.isLock,function(t,e,i){var n,o;e?(b(t,i),f(t,"zIndex",C(T.Locked,t))):(o=i,(n=t).className=n.className.replaceAll(o,""),f(t,"zIndex",C(T.Checked,t)))}(i.privateTarget,n.isLock,o),G(i.pointElements,!1)},dragCallbacks:{beforeCallback:t=>!t.isLock,afterCallback:t=>!t.isLock},resizeCallbacks:{beforeCallback:t=>!t.isLock,afterCallback:t=>!t.isLock},mousedownCallbacks:{beforeCallback:t=>!t.isLock}},blowUp:{name:"blowUp",actionName:"放大",actionDom:null,actionCallback(t){const{stateParameter:{targetState:e,pointState:i},globalDataParameter:{initialTarget:n},elementParameter:{pointElements:o,privateTarget:a}}=t.currentState;if(n.isLock)return;const r=M({width:n.originWidth,height:n.originHeight},.1);e.width+=r.x,e.height+=r.y,tt(a,{direction:"rb",movementX:{value:r.x},movementY:{value:r.y}},{initialTarget:n,pointElements:o,pointSize:10,pointState:i},{excludeCurPoint:!1}),n.width+=r.x,n.height+=r.y,a.style.width=n.width+"px",a.style.height=n.height+"px"}},reduce:{name:"reduce",actionName:"缩小",actionDom:null,actionCallback(t){const{stateParameter:{targetState:e,pointState:i},globalDataParameter:{initialTarget:n},elementParameter:{pointElements:o,privateTarget:a},optionParameter:{pointSize:r}}=t.currentState;if(n.isLock)return;const s=M({width:n.originWidth,height:n.originHeight},.1);e.width-=s.x,e.height-=s.y,tt(a,{direction:"rb",movementX:{value:-s.x},movementY:{value:-s.y}},{initialTarget:n,pointElements:o,pointSize:r,pointState:i},{excludeCurPoint:!1}),n.width-=s.x,n.height-=s.y,a.style.width=n.width+"px",a.style.height=n.height+"px"}},copy:{name:"copy",actionName:"复制",actionDom:null,actionCallback(t){const{globalDataParameter:{initialTarget:e,plugins:i},elementParameter:{privateTarget:n},optionParameter:{containerSelector:o}}=t.currentState;if(e.isLock)return;const{actionList:a,options:r}=this.getMenuContextParameter(),s=n.parentNode,l=n.cloneNode(),c=H.classCopyPrefix+H.copyIndex++;l.className=c,l.style.width=n.offsetWidth+"px",l.style.height=n.offsetHeight+"px",l.style.left=e.left+r.offsetX+"px",l.style.top=e.top+r.offsetY+"px",s.appendChild(l)}},delete:{name:"delete",actionName:"删除",actionDom:null,actionCallback(t){const{elementParameter:{privateTarget:e,pointElements:i},globalDataParameter:{initialTarget:n}}=t.currentState;n.isLock||(G(i,!1),e.remove())}},rotate:{name:"rotate",actionName:"旋转",actionDom:null,actionCallback(t){const{elementParameter:{privateTarget:e,pointElements:i},globalDataParameter:{initialTarget:n,downPointPosition:o}}=t.currentState;n.rotate=45,e.style.transform="rotate(45deg)",function({initialTarget:t,downPointPosition:e},{pointElements:i},{rotate:n,updateStyle:o=!1}){const a=function({width:t,height:e,left:i,top:n},o){const a={};for(const i in o)a[i]=R[i](o.lt,{width:t,height:e});return a}(t,e),r=n*Math.PI/180;for(const e in a)a[e]=O(a[e],r,t),o&&f(i[e],{left:a[e][0],top:a[e][1]})}({initialTarget:n,downPointPosition:o},{pointElements:i},{rotate:45,updateStyle:!0})}},uppermost:{name:"uppermost",actionName:"置顶",actionDom:null,customData:{index:0},actionCallback(t){const{elementParameter:{privateTarget:e},globalDataParameter:{initialTarget:i}}=t.currentState;f(e,"zIndex",C(T.Uppermost,e)+ ++this.customData.index),i.zIndex=T.Uppermost+this.customData.index},mousedownCallbacks:{}},lowest:{name:"lowest",actionName:"置底",actionDom:null,customData:{index:0},actionCallback(t){const{elementParameter:{privateTarget:e},globalDataParameter:{initialTarget:i}}=t.currentState;f(e,"zIndex",C(T.Lowest,e)-++this.customData.index),i.zIndex=T.Lowest-this.customData.index},mousedownCallbacks:{afterCallback(t,e){e.currentState;const i=e.notLockState;for(const t of i)f(t.target,"zIndex",t.zIndex||C(T.Normal,t.target))}}}};function _(t){const e=[];for(const[i,n]of Object.entries(A))e.push({name:n.name,actions:n[t]});return e}function W(t,e,i){const n=e.currentState.globalDataParameter.initialTarget;let o=!0;try{for(let a=0;a<t.length;a++){const r=t[a];if(o=r?.actions?.[i]?.(n,e)??!0,!1===o)break}}catch(t){return console.log(t,"----错误---"),!1}return o}function O(t,e,{width:i,height:n,left:o,top:a}){const r=i/2+o,s=n/2+a,l=t[0]-r,c=t[1]-s;return[l*Math.cos(e)-c*Math.sin(e)+r,l*Math.sin(e)+c*Math.cos(e)+s]}const R={lt:([t,e],{width:i,height:n})=>[t,e],rt:([t,e],{width:i,height:n})=>[t+i,e],lb:([t,e],{width:i,height:n})=>[t,e+n],rb:([t,e],{width:i,height:n})=>[t+i,e+n],l:([t,e],{width:i,height:n})=>[t,e+n/2],t:([t,e],{width:i,height:n})=>[t+i/2,e],r:([t,e],{width:i,height:n})=>[t+i,e+n/2],b:([t,e],{width:i,height:n})=>[t+i/2,e+n]};_("dragCallbacks"),_("resizeCallbacks");const V=_("mousedownCallbacks"),j=["lt","lb","rt","rb","l","r","t","b"];function q(t){const e=t.indexOf("l")>-1,i=t.indexOf("r")>-1,n=t.indexOf("b")>-1;return{hasL:e,hasR:i,hasT:t.indexOf("t")>-1,hasB:n}}const $={left({movementX:t,limitMinDistanceX:e,limitMaxDistanceX:i}){t.value>e&&(t.value=e),i+t.value<0&&(t.value=-i)},right({movementX:t,limitMinDistanceX:e,limitMaxDistanceX:i}){-t.value>e&&(t.value=-e),t.value>i&&(t.value=i)},top({movementY:t,limitMinDistanceY:e,limitMaxDistanceY:i}){t.value>e&&(t.value=e),i+t.value<0&&(t.value=-i)},bottom({movementY:t,limitMinDistanceY:e,limitMaxDistanceY:i}){-t.value>e&&(t.value=-e),t.value>i&&(t.value=i)}},F={left({movementX:t,initialTarget:e}){t.value+e.left<=0&&(t.value=-e.left)},right({movementX:t,initialTarget:e,containerInfo:i}){t.value+e.left+e.width>=i.width+i.offsetLeft&&(t.value=i.width-e.left-e.width+i.offsetLeft)},top({movementY:t,initialTarget:e}){t.value+e.top<=0&&(t.value=-e.top)},bottom({movementY:t,initialTarget:e,containerInfo:i}){t.value+e.top+e.height>=i.height+i.offsetTop&&(t.value=i.height-e.top-e.height+i.offsetTop)}};function B({minWidth:t,minHeight:e,maxWidth:i,maxHeight:n},{initialTarget:o,containerInfo:a}){const r={};return j.forEach((s=>{r[s]=({movementX:r,movementY:l})=>{const{width:c,height:m}=o,{hasT:h,hasR:u,hasB:d,hasL:p}=q(s),f=c-t,g=m-e,v=i-c,b=n-m;p&&((t,e,i)=>{$.left({movementX:t,limitMinDistanceX:e,limitMaxDistanceX:i}),F.left({movementX:t,initialTarget:o})})(r,f,v),h&&((t,e,i)=>{$.top({movementY:t,limitMinDistanceY:e,limitMaxDistanceY:i}),F.top({movementY:t,initialTarget:o})})(l,g,b),u&&((t,e,i)=>{$.right({movementX:t,limitMinDistanceX:e,limitMaxDistanceX:i}),F.right({movementX:t,initialTarget:o,containerInfo:a})})(r,f,v),d&&((t,e,i)=>{$.bottom({movementY:t,limitMinDistanceY:e,limitMaxDistanceY:i}),F.bottom({movementY:t,initialTarget:o,containerInfo:a})})(l,g,b)}})),r}function U(t,e,i){f(t,"left",e[i][0]+"px"),f(t,"top",e[i][1]+"px")}function K(t,e,i){if("object"==typeof e)for(const i in t)t[i]=e[i]??t[i];else t[e]=i}function G(t,e){for(const i in t)f(t[i],"display",e?"block":"none")}function J(t,e,i,n,o){const{globalDataParameter:{initialTarget:a,downPointPosition:r},stateParameter:{pointState:s},optionParameter:{pointSize:l,skill:c},elementParameter:{allContainer:m,target:h,privateTarget:u}}=n.getElementState(t);if([...m,document.body,document.documentElement].includes(o.target)&&(G(e,!1),u===h.value&&f(h.value,"zIndex",a.zIndex||C(T.Normal,h.value))),o.target!==t)return;a.isLock&&G(e,!1),n.setCurrentElement(t);if(!1===W(V,n,"beforeCallback"))return;const d=c.resize&&tt(t,{direction:"t",movementX:{value:0},movementY:{value:0}},{initialTarget:a,pointElements:e,pointSize:l,pointState:s},{excludeCurPoint:!1,updateDirection:!1});for(const t in d)r[t]=[d[t][0],d[t][1]];G(e,!0),f(t,"zIndex",C(T.Checked,t)),W(V,n,"afterCallback")}function Q(t,e,i){let n;return(o,a=!0)=>{a?window.addEventListener("mousedown",n??(n=J.bind(null,o,t,e,i))):window.removeEventListener("mousedown",n)}}function Z(t,{direction:e,movementX:i,movementY:n},{targetState:o,initialTarget:a}){const r=function(){const t={};return j.forEach((e=>{const{hasT:i,hasR:n,hasB:o,hasL:a}=q(e);t[e]=({left:t,top:e,height:r,width:s,offsetX:l,offsetY:c})=>({left:u(a,t+l+"px",t+"px"),top:u(i,e+c+"px",e+"px"),width:u(a,s-l+"px",u(n,s+l+"px",s+"px")),height:u(i,r-c+"px",u(o,r+c+"px",r+"px"))})})),t}(),s=r[e]({left:a.left,top:a.top,width:a.width,height:a.height,offsetX:i.value,offsetY:n.value});return function(t,e,i){const{hasL:n,hasT:o}=q(t),{left:a,top:r,width:s,height:l}=function(t){const e={};for(const i in t)e[i]=parseInt(t[i]);return e}(i);K(e,o&&n?{left:a,top:r,width:s,height:l}:o?{top:r,width:s,height:l}:n?{left:a,width:s,height:l}:{width:s,height:l})}(e,o,s),f(t,s),s}function tt(t,{direction:e,movementX:i,movementY:n},{initialTarget:o,pointElements:a,pointSize:r,pointState:s},l={}){const{excludeCurPoint:c=!0,updateDirection:m=!0}=l,h=function(){const t={};return j.forEach((e=>{const{hasT:i,hasR:n,hasB:o,hasL:a}=q(e);t[e]=({left:t,top:e,width:r,height:s,movementX:l,movementY:c})=>({left:u(a,t+l.value,t),top:u(i,e+c.value,e),width:u(a,r-l.value,u(n,r+l.value,r)),height:u(i,s-c.value,u(o,s+c.value,s))})})),t}(),d=function({left:t,top:e,width:i,height:n},o){const a=o/2;return{lt:[t-a,e-a,"nw-resize"],lb:[t-a,e+n-a,"ne-resize"],rt:[t+i-a,e-a,"ne-resize"],rb:[t+i-a,e+n-a,"nw-resize"],t:[t+i/2-a,e-a,"n-resize","X"],b:[t+i/2-a,e+n-a,"n-resize","X"],l:[t-a,e+n/2-a,"e-resize","Y"],r:[t+i-a,e+n/2-a,"e-resize","Y"]}}(h[e]({...o,movementX:i,movementY:n}),r);for(const t in d)if(t!==e)U(a[t],d,t);else{K(s,{direction:m?e:null,left:d[t][0],top:d[t][1],movementX:i.value,movementY:n.value})}return c||U(a[e],d,e),d}function et(t,i){return t&&i&&K(t,i),e({left:0,top:0,width:0,height:0})}class it{constructor(t=new L,e,i){this.plugins=t,this.stateManager=i,this.start(i.currentState)}start(t){const{pointElements:e,target:i,targetState:n,containerInfo:o,initialTarget:r,downPointPosition:s,drag:l,limitDragDirection:c,dragCallback:m}={target:(h=t).elementParameter.target,container:h.elementParameter.container,privateTarget:h.elementParameter.privateTarget,privateContainer:h.elementParameter.privateContainer,pointElements:h.elementParameter.pointElements,allTarget:h.elementParameter.allTarget,allContainer:h.elementParameter.allContainer,pointState:h.stateParameter.pointState,targetState:h.stateParameter.targetState,initialTarget:h.globalDataParameter.initialTarget,containerInfo:h.globalDataParameter.containerInfo,downPointPosition:h.globalDataParameter.downPointPosition,drag:h.optionParameter.skill.drag,resize:h.optionParameter.skill.resize,limitDragDirection:h.optionParameter.skill.limitDragDirection,dragCallback:h.optionParameter.callbacks.dragCallback,resizeCallback:h.optionParameter.callbacks.resizeCallback,customPointClass:h.optionParameter.customClass.customPointClass,containerSelector:h.optionParameter.containerSelector,minWidth:h.optionParameter.minWidth,minHeight:h.optionParameter.minHeight,maxWidth:h.optionParameter.maxWidth,maxHeight:h.optionParameter.maxHeight,pointSize:h.optionParameter.pointSize};var h;l&&f(i.value,"cursor","all-scroll");const{movementX:u,movementY:d,isPress:p}=N(i.value,this.moveTargetCallback(m,{downPointPosition:s,pointElements:e,targetState:n,containerInfo:o}),{limitDirection:c,offsetLeft:o.offsetLeft,offsetTop:o.offsetTop});a(p,this.isPressChangeCallback({...t.elementParameter},{targetState:n},{downPointPosition:s,initialTarget:r},{movementX:u,movementY:d}))}dragStart(){this.plugins.callExtensionPoint("onDragStart")}moveTargetCallback(t,{downPointPosition:e,pointElements:i,targetState:n,containerInfo:o}){return(a,r)=>{const s=this.stateManager.currentState,l=s.globalDataParameter.initialTarget;function c(t){!function(t,e,i){for(const n in i)f(i[n],"left",t[n][0]+e.x+"px"),f(i[n],"top",t[n][1]+e.y+"px")}(e,t,i)}function m(t){K(n,{left:l.left+t.x,top:l.top+t.y})}g((()=>{a(),this.limitTargetMove(l,o,r),c(r),m(r)}),t,{movementX:r.x,movementY:r.y}),this.plugins.callExtensionPoint("drag",s,{movement:r,_updateContourPointPosition:c,_updateState:m})}}limitTargetMove(t,e,i){const{left:n,top:o,width:a,height:r}=t,{width:s,height:l,offsetLeft:c,offsetTop:m}=e;i.x+n<=0&&(i.x=-n),i.y+o<=0&&(i.y=-o),i.x+n+a>=s+c&&(i.x=s+c-a-n),i.y+o+r>=l+m&&(i.y=l+m-r-o)}targetMouseDown({downPointPosition:t,pointElements:e}){!function({downPointPosition:t,pointElements:e}){for(const i in e)t[i]=[parseInt(e[i].style.left),parseInt(e[i].style.top)]}({downPointPosition:t,pointElements:e})}targetMouseUp({initialTarget:t,movementX:e,movementY:i}){et(t,{top:t.top+i.value,left:t.left+e.value})}isPressChangeCallback(t,{targetState:e},{downPointPosition:i,initialTarget:n},{movementX:o,movementY:a}){return r=>{K(e,"isPress",r),r?this.targetMouseDown({downPointPosition:i,pointElements:t.pointElements}):this.targetMouseUp({initialTarget:n,movementX:o,movementY:a}),this.plugins.callExtensionPoint("targetPressChange",r,t)}}}const nt=_("resizeCallbacks");class ot{constructor(t=new L,e,i){this.plugins=t,this.stateManager=i,this.setPointStyle(),this.init(i.currentState)}init({elementParameter:t,stateParameter:e,globalDataParameter:i,optionParameter:n}){const o=this.createParentPosition(i.initialTarget,n.pointSize);this.initContourPoints(t,e,i,n,{pointPosition:o})}setPointStyle(){const t=document.createElement("style");t.appendChild(document.createTextNode("\n      .magic_drag-outline_point {\n        position: absolute;\n        box-sizing: border-box;\n        border: 1px solid #999;\n        border-radius: 50%;\n        display: none;\n        z-index: 88888;\n      }\n    ")),document.body.appendChild(t)}createParentPosition({left:t,top:e,width:i,height:n},o){const a=o/2;return{lt:[t-a,e-a,"nw-resize"],lb:[t-a,e+n-a,"ne-resize"],rt:[t+i-a,e-a,"ne-resize"],rb:[t+i-a,e+n-a,"nw-resize"],t:[t+i/2-a,e-a,"n-resize","X"],b:[t+i/2-a,e+n-a,"n-resize","X"],l:[t-a,e+n/2-a,"e-resize","Y"],r:[t+i-a,e+n/2-a,"e-resize","Y"]}}initContourPoints(t,e,i,n,o){const{target:r,pointElements:s}=t,{pointState:l}=e,{pointPosition:c}=o,{pointSize:m,customClass:{customPointClass:h}}=n,{initialTarget:u}=i;for(const o in c){const d=this.createContourPoint(s,{direction:o});this.initPointStyle(d,{pointPosition:c,direction:o,pointSize:m}),b(d,h),v(r.value.parentNode,d);const p=this.addDragFunctionToPoint(t,e,i,n,{point:d,pointPosition:c,direction:o});a(p,this.pointIsPressChangeCallback(r.value,{initialTarget:u,pointState:l,direction:o},t))}}pointIsPressChangeCallback(t,{initialTarget:e,pointState:i,direction:n},o){return a=>{const r=this.stateManager.currentElement;var s;t===r&&(i.isPress=a,i.direction=n,a||(i.direction=null,et(e,{width:(s=t).offsetWidth,height:s.offsetHeight,left:s.offsetLeft,top:s.offsetTop})),this.plugins.callExtensionPoint("pointPressChange",a,o))}}initPointStyle(t,{pointPosition:e,direction:i,pointSize:n},o){o&&f(t,o),f(t,"width",n+"px"),f(t,"height",n+"px"),f(t,"cursor",e[i][2]),U(t,e,i)}addDragFunctionToPoint(t,e,i,n,o){const{target:a}=t,{point:r,pointPosition:s,direction:l}=o,{resizeCallback:c}=n.callbacks||{},{isPress:m,movementX:h,movementY:u}=N(r,(o=>{g((()=>{this.movePointCallback(e,t,i,n,{direction:l,movementX:h,movementY:u,moveAction:o,target:a.value})}),c,l,{movementX:h.value,movementY:u.value})}),{limitDirection:s[l][3]});return m}movePointCallback(t,e,i,n,o){const{moveAction:a,target:r,direction:s,movementX:l,movementY:c}=o,m=this.stateManager.getElementState(r),{globalDataParameter:{initialTarget:h,containerInfo:u},stateParameter:{targetState:d,pointState:p},optionParameter:{minWidth:f,minHeight:g,maxWidth:v,maxHeight:b,pointSize:P},elementParameter:{pointElements:y}}=m;if(!1===W(nt,this.stateManager,"beforeCallback"))return;a();const x=({movementX:t,movementY:e})=>{Z(r,{direction:s,movementX:t,movementY:e},{targetState:d,initialTarget:h})},w=({movementX:t,movementY:e})=>{tt(0,{direction:s,movementX:t,movementY:e},{initialTarget:h,pointElements:y,pointSize:P,pointState:p})};!function(t,{direction:e,movementX:i,movementY:n},{initialTarget:o,containerInfo:a,minWidth:r,minHeight:s,maxWidth:l,maxHeight:c}){B({minWidth:r,minHeight:s,maxWidth:l,maxHeight:c},{initialTarget:o,containerInfo:a})[e]({movementX:i,movementY:n})}(0,{direction:s,movementX:l,movementY:c},{initialTarget:h,containerInfo:u,minWidth:f,minHeight:g,maxWidth:v,maxHeight:b}),x({movementX:l,movementY:c}),w({movementX:l,movementY:c}),this.plugins.callExtensionPoint("resize",m,{movementX:l,movementY:c,_updateTargetStyle:x,_updatePointPosition:w})}createContourPoint(t,{direction:e}){return t[e]||(t[e]=document.createElement("div"))}}const at={containerSelector:"body",minWidth:10,minHeight:10,maxWidth:999999,maxHeight:999999,pointSize:10,initialInfo:{width:200,height:200,left:0,top:0},skill:{resize:!0,drag:!0,refLine:!0,keymap:!1,limitDragDirection:null},customClass:{customPointClass:S.OutlinePoint},callbacks:{}};function rt(){return P(at)}const st=[],lt=[];let ct=t(null),mt=t(null);function ht(t){!function(t){function e(){return t.left<0||t.top<0}p(e(),"It is not recommended that the initial location information be set to a negative value")}(t.initialInfo),function(t){function e(){return t.initialInfo.height<t.minHeight||t.initialInfo.width<t.minWidth}function i(){return t.initialInfo.height>t.maxHeight||t.initialInfo.width>t.maxWidth}function n(){return t.minWidth>t.maxWidth||t.minHeight>t.maxHeight}d(n(),"The minimum cannot be greater than the maximum"),p(e(),"The initial size cannot be less than the minimum size"),p(i(),"The initial size cannot be greater than the maximum size")}(t)}const{allTarget:ut,allContainer:dt}={allTarget:st,allContainer:lt};let{$target:pt,$container:ft,initialTarget:gt,pointElements:vt,containerInfo:bt,downPointPosition:Pt}={$target:ct,$container:mt,initialTarget:void 0,pointElements:void 0,containerInfo:void 0,downPointPosition:void 0};const{targetState:yt,pointState:xt}={targetState:e({left:0,top:0,height:0,width:0,isPress:!1,isLock:!1}),pointState:e({left:0,top:0,direction:null,isPress:!1,movementX:0,movementY:0})};function wt(t,e){return t.direction?t[e]:null}var St;function Tt(t,e,o=!1){const{containerSelector:a}=e;pt.value=null,ft.value=null,gt=et(),vt=vt||{},bt={},Pt={},Object.assign(yt,{left:0,top:0,height:0,width:0,isPress:!1,isLock:!1}),Object.assign(xt,{left:0,top:0,direction:null,isPress:!1,movementX:0,movementY:0}),"body"===e.containerSelector&&(document.body.style.overflow="hidden");const s={pointState:xt,targetState:yt},m={initialTarget:gt,containerInfo:bt,downPointPosition:Pt},h={pointElements:vt,allTarget:ut,allContainer:dt,target:pt,container:ft,privateTarget:null,privateContainer:null},u=Q(h.pointElements,s.targetState,k);return l((function(){ht(e),function(){function t(){o(i(),n())}function e(){h.privateContainer=ft.value=c(a),dt.push(h.privateContainer)}function i(){const{paddingLeft:t,paddingRight:e,paddingTop:i,paddingBottom:n,width:o,height:a,boxSizing:r,borderLeftWidth:s,borderRightWidth:l,borderTopWidth:c,borderBottomWidth:m}=getComputedStyle(h.container.value);return{containerWidth:p(),containerHeight:d()};function u(){return"border-box"===r}function d(){return u()?parseInt(a)-parseInt(i)-parseInt(n)-parseInt(m)-parseInt(c):parseInt(a)}function p(){return u()?parseInt(o)-parseInt(t)-parseInt(e)-parseInt(s)-parseInt(l):parseInt(o)}}function n(){const t=h.container.value.getBoundingClientRect();return{offsetLeft:t.left,offsetTop:t.top}}function o({containerWidth:t,containerHeight:e},{offsetLeft:i,offsetTop:n}){m.containerInfo.width=t,m.containerInfo.height=e,m.containerInfo.offsetLeft=i,m.containerInfo.offsetTop=n}e(),o(i(),n()),s=t,r.push(s);var s}(),function(){function i(){return{position:{left:m.containerInfo.offsetLeft+e.initialInfo.left,top:m.containerInfo.offsetTop+e.initialInfo.top},size:{width:e.initialInfo.width,height:e.initialInfo.height}}}function n(){h.privateTarget=pt.value=c(t),ut.push(pt.value)}function a(){pt.value.addEventListener("click",p),pt.value.dataset.index=ut.length}n(),d(!pt.value,"targetSelector is an invalid selector or HTMLElement"),a(),r=pt.value,l=i().size,u=i().position,f(r,"position","absolute"),f(r,y(u)),[0===r.offsetWidth||0===r.offsetHeight,getComputedStyle(r).position][0]&&f(r,y(l)),function(t,e,i){const n={left:i?parseInt(t.style.left):t.offsetLeft,top:i?parseInt(t.style.top):t.offsetTop,width:i?parseInt(t.style.width):t.offsetWidth,height:i?parseInt(t.style.height):t.offsetHeight};for(const t in e)e[t]=n[t]||e[t]}(pt.value,m.initialTarget,o),K(s.targetState,m.initialTarget);var r,l,u}(),function(t,e,i){k.registerElementState(t,e,i)}(pt.value,g(),!0),e.skill.drag&&new it(z,g(),k),e.skill.resize&&new ot(z,g(),k),u(pt.value)})),console.info("待实现"),{targetLeft:n(s.targetState,"left"),targetTop:n(s.targetState,"top"),targetWidth:n(s.targetState,"width"),targetHeight:n(s.targetState,"height"),targetIsPress:n(s.targetState,"isPress"),targetIsLock:n(s.targetState,"isLock"),pointLeft:i((()=>wt(s.pointState,"left"))),pointTop:i((()=>wt(s.pointState,"top"))),direction:n(s.pointState,"direction"),pointIsPress:n(s.pointState,"isPress"),pointMovementX:n(s.pointState,"movementX"),pointMovementY:n(s.pointState,"movementY")};function p(t){pt.value=t.target}function g(){return{elementParameter:h,stateParameter:s,globalDataParameter:m,optionParameter:e}}}function Ct(t,e){return d("string"!=typeof t&&!(t instanceof HTMLElement),"targetSelector should be a selector or HTML Element"),function(t,e={}){for(const i in t){const n=e[i];if(h(n))continue;const o=typeof t[i],a=typeof n;d(o!==a,`The type of options.${i} should be ${o}, But the ${a} type is passed in.`)}}(rt(),e),d((e=m(rt(),e)).customClass.customPointClass.startsWith(x),`custom class names cannot start with ${x}, please change your class name`),Tt(t,e)}(St=rt().skill).refLine&&function(){const t=new I({gap:10});z.registerPlugin(t.name,t)}(),St.keymap&&function(){const t=new X;z.registerPlugin(t.name,t)}(),z.installPlugin();export{Ct as useMagicDrag,N as useMoveElement};
